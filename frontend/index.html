<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparo em Massa - WhatsApp</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Verificação de Autenticação -->
    <script>
        // Verificar se está autenticado
        if (!localStorage.getItem('authenticated')) {
            window.location.href = 'login.html';
        }
    </script>

    <div class="container">
        <header>
            <h1>📱 Disparo em Massa - WhatsApp</h1>
            <p class="subtitle">Gerenciamento de campanhas integrado com Evolution API</p>
            <button onclick="logout()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                🚪 Sair
            </button>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="campanhas">Campanhas</button>
            <button class="tab-btn" data-tab="nova-campanha">Nova Campanha</button>
            <button class="tab-btn" data-tab="instancias">Instâncias</button>
            <button class="tab-btn" data-tab="metricas">📊 Métricas & Aquecimento</button>
        </nav>

        <!-- Tab: Campanhas -->
        <div id="campanhas-tab" class="tab-content active">
            <h2>Minhas Campanhas</h2>
            <div id="campanhas-list" class="campanhas-grid">
                <div class="loading">Carregando campanhas...</div>
            </div>
        </div>

        <!-- Tab: Nova Campanha -->
        <div id="nova-campanha-tab" class="tab-content">
            <h2>Criar Nova Campanha</h2>
            <form id="form-campanha" class="form">
                <div class="form-group">
                    <label for="nome">Nome da Campanha</label>
                    <input type="text" id="nome" name="nome" required placeholder="Ex: Promoção Black Friday">
                </div>

                <div class="form-group">
                    <label for="instancia">Instância do WhatsApp</label>
                    <select id="instancia" name="instance_name" required>
                        <option value="">⏳ Carregando instâncias...</option>
                    </select>
                    <small>⚠️ Aguarde o carregamento das instâncias conectadas antes de criar a campanha</small>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo de Mensagem</label>
                    <select id="tipo" name="tipo" required>
                        <option value="texto">Texto</option>
                        <option value="imagem">Imagem</option>
                        <option value="video">Vídeo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mensagem">Mensagem</label>
                    <textarea id="mensagem" name="mensagem" rows="5" required placeholder="Digite sua mensagem..."></textarea>
                </div>

                <div id="media-fields" class="form-group" style="display: none;">
                    <label for="media_url">URL da Mídia</label>
                    <input type="url" id="media_url" name="media_url" placeholder="https://exemplo.com/imagem.jpg">

                    <label for="media_filename">Nome do Arquivo</label>
                    <input type="text" id="media_filename" name="media_filename" placeholder="imagem.jpg">

                    <label for="mimetype">MIME Type</label>
                    <select id="mimetype" name="mimetype">
                        <option value="image/jpeg">image/jpeg</option>
                        <option value="image/png">image/png</option>
                        <option value="video/mp4">video/mp4</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="delay">Delay entre envios (segundos)</label>
                    <input type="number" id="delay" name="delay_entre_envios" value="5" min="1" required>
                </div>

                <div class="form-group">
                    <label>Origem dos Contatos</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="origem_contatos" value="supabase" checked>
                            Buscar do Supabase
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="origem_contatos" value="manual">
                            Digitar Manualmente
                        </label>
                    </div>
                </div>

                <!-- Buscar Clientes do Supabase -->
                <div id="supabase-section" class="form-group" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                    <h3 style="margin-top: 0;">🔍 Buscar Clientes do Supabase</h3>

                    <!-- Filtros Rápidos -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">⚡ Filtros Rápidos:</label>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-small" onclick="aplicarFiltroRapido(10)"
                                    style="background: #28a745; color: white;">
                                📅 Últimos 10 min
                            </button>
                            <button type="button" class="btn btn-small" onclick="aplicarFiltroRapido(1440)"
                                    style="background: #17a2b8; color: white;">
                                📅 Últimas 24h
                            </button>
                            <button type="button" class="btn btn-small" onclick="aplicarFiltroRapido(4320)"
                                    style="background: #6c757d; color: white;">
                                📅 Últimas 72h
                            </button>
                            <button type="button" class="btn btn-small" onclick="limparFiltros()"
                                    style="background: #dc3545; color: white;">
                                🗑️ Limpar
                            </button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label for="filtro_data_inicio">Data Início</label>
                            <input type="datetime-local" id="filtro_data_inicio">
                        </div>
                        <div>
                            <label for="filtro_data_fim">Data Fim</label>
                            <input type="datetime-local" id="filtro_data_fim">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label for="filtro_nome">Nome do Cliente</label>
                            <input type="text" id="filtro_nome" placeholder="Buscar por nome...">
                        </div>
                        <div>
                            <label for="filtro_instancia">Instância</label>
                            <input type="text" id="filtro_instancia" placeholder="Ex: cc_8999">
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="buscarClientesSupabase()">
                        🔍 Buscar Clientes
                    </button>

                    <div id="clientes-result" style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
                        <p style="color: #666;">Clique em "Buscar Clientes" para carregar...</p>
                    </div>

                    <div id="clientes-selecionados" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                        <strong>Clientes selecionados: <span id="count-selecionados">0</span></strong>
                    </div>
                </div>

                <!-- Lista Manual de Contatos -->
                <div id="manual-section" class="form-group" style="display: none;">
                    <label for="contatos">Lista de Contatos (um por linha)</label>
                    <textarea id="contatos" rows="10" placeholder="5531999999999&#10;5531888888888&#10;..."></textarea>
                    <small>Digite um número por linha com DDD e código do país (ex: 5531999999999)</small>
                </div>

                <button type="submit" class="btn btn-primary">Criar Campanha</button>
            </form>
        </div>

        <!-- Tab: Instâncias -->
        <div id="instancias-tab" class="tab-content">
            <h2>🔌 Gerenciamento de Instâncias Evolution API</h2>
            <p style="color: #666; margin-bottom: 20px;">Controle completo das instâncias WhatsApp conectadas</p>

            <!-- Botões de Ação -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="mostrarFormCriarInstancia()">
                    ➕ Nova Instância
                </button>
                <button class="btn btn-secondary" onclick="atualizarListaInstancias()">
                    🔄 Atualizar Lista
                </button>
            </div>

            <!-- Formulário para Criar Nova Instância (inicialmente oculto) -->
            <div id="form-criar-instancia" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">Criar Nova Instância</h3>
                <form id="form-nova-instancia" onsubmit="criarNovaInstancia(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="nova_instance_name">Nome da Instância *</label>
                            <input type="text" id="nova_instance_name" required placeholder="minha-instancia-01">
                            <small>Use apenas letras, números e hífens</small>
                        </div>

                        <div class="form-group">
                            <label for="nova_integration">Tipo de Integração *</label>
                            <select id="nova_integration" required>
                                <option value="WHATSAPP-BAILEYS">WhatsApp Web (Baileys)</option>
                                <option value="WHATSAPP-BUSINESS">WhatsApp Business API</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nova_number">Número (opcional)</label>
                            <input type="text" id="nova_number" placeholder="5511999999999">
                        </div>

                        <div class="form-group">
                            <label for="nova_token">Token (opcional)</label>
                            <input type="text" id="nova_token" placeholder="Token de autenticação">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="submit" class="btn btn-primary">Criar Instância</button>
                        <button type="button" class="btn btn-secondary" onclick="ocultarFormCriarInstancia()">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Lista de Instâncias -->
            <div id="instancias-evolution-list" style="display: grid; gap: 15px;">
                <div class="loading">Carregando instâncias...</div>
            </div>

            <!-- Modal para QR Code -->
            <div id="modal-qrcode" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="fecharModalQRCode()">&times;</span>
                    <h2>📱 Conectar Instância</h2>
                    <div id="qrcode-container" style="text-align: center; padding: 20px;">
                        <div class="loading">Gerando QR Code...</div>
                    </div>
                    <p style="text-align: center; color: #666; margin: 10px 0;">
                        Escaneie o QR Code com o WhatsApp do seu celular
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab: Métricas & Aquecimento -->
        <div id="metricas-tab" class="tab-content">
            <h2>📊 Dashboard Anti-Bloqueio</h2>
            <p style="color: #666; margin-bottom: 20px;">Sistema de métricas em tempo real e aquecimento gradual de números WhatsApp</p>

            <!-- Seletor de Instância -->
            <div class="form-group">
                <label for="instance-metrics">Selecione a Instância:</label>
                <select id="instance-metrics" onchange="carregarMetricas()" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="">-- Selecione uma instância --</option>
                </select>
            </div>

            <!-- Cards de Métricas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">Mensagens Hoje</h4>
                    <p style="margin: 0; font-size: 32px; font-weight: bold;" id="daily-count">-</p>
                    <small id="daily-limit" style="opacity: 0.8;">de 500</small>
                </div>

                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">Mensagens Esta Hora</h4>
                    <p style="margin: 0; font-size: 32px; font-weight: bold;" id="hourly-count">-</p>
                    <small style="opacity: 0.8;">de 50</small>
                </div>

                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">Status Aquecimento</h4>
                    <p style="margin: 0; font-size: 24px; font-weight: bold;" id="warmup-status">-</p>
                    <small id="warmup-day" style="opacity: 0.8;">-</small>
                </div>

                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: white;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">Horário Permitido</h4>
                    <p style="margin: 0; font-size: 24px; font-weight: bold;" id="business-hours">-</p>
                    <small style="opacity: 0.8;">8h - 20h (Seg-Sex)</small>
                </div>
            </div>

            <!-- Barra de Progresso Aquecimento -->
            <div id="warmup-progress" style="display:none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0;">
                <h3 style="margin-top: 0;">🔥 Progresso do Aquecimento</h3>
                <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden; margin: 15px 0;">
                    <div id="warmup-progress-bar" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.5s;"></div>
                </div>
                <p id="warmup-description" style="color: #666; margin: 0;">-</p>
            </div>

            <!-- Ações -->
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="iniciarAquecimento()" style="background: #667eea; color: white;">
                    🔥 Iniciar Aquecimento
                </button>
                <button class="btn" onclick="pararAquecimento()" style="background: #dc3545; color: white;">
                    ⏹️ Parar Aquecimento
                </button>
                <button class="btn btn-secondary" onclick="carregarMetricas()">
                    🔄 Atualizar
                </button>
                <button class="btn" onclick="verCronograma()" style="background: #17a2b8; color: white;">
                    📅 Ver Cronograma
                </button>
            </div>

            <!-- Informações de Proteção -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #28a745;">
                <h3 style="margin-top: 0;">🛡️ Proteções Ativas</h3>
                <ul style="margin: 0; padding-left: 20px; color: #666;">
                    <li>✅ <strong>Delays Inteligentes:</strong> 20-90 segundos entre mensagens</li>
                    <li>✅ <strong>Limites Automáticos:</strong> 50 msgs/hora, 500 msgs/dia</li>
                    <li>✅ <strong>Horário Comercial:</strong> Apenas Seg-Sex das 8h às 20h</li>
                    <li>✅ <strong>Pausas Preventivas:</strong> A cada 20 e 100 mensagens</li>
                    <li>✅ <strong>Personalização:</strong> Variáveis {{nome}} e {{telefone}}</li>
                    <li>✅ <strong>Validação:</strong> Números formatados automaticamente</li>
                </ul>
            </div>

            <!-- Cronograma Completo (inicialmente oculto) -->
            <div id="cronograma-section" style="display: none; margin-top: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>📅 Cronograma de Aquecimento (28 dias)</h3>
                <div id="warmup-schedule" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Modal de Detalhes da Campanha -->
        <div id="modal-campanha" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="modal-title">Detalhes da Campanha</h2>
                <div id="modal-body"></div>
                <div id="modal-actions"></div>
            </div>
        </div>

        <!-- Modal de Contatos -->
        <div id="modal-contatos" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Contatos da Campanha</h2>
                <div id="contatos-list"></div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
